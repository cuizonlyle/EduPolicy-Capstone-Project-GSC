@using front3.Models
@model HomeModel3
@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sanction Info</title>
    <link href="~/Content/bootstrap.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link href="~/Content/SanctionInfo.css" rel="stylesheet" />
</head>
<body>
    <!-- Success Modal HTML -->
    <div class="modal fade" id="changedStat" tabindex="-1" aria-labelledby="changedStatLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-success" id="changedStatLabel">Success</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="changedStat1">
                    <!-- Success message content -->
                </div>
            </div>
        </div>
    </div>

    <!-- No Records Fail Modal HTML -->
    <div class="modal fade" id="noRecords" tabindex="-1" aria-labelledby="noRecordsLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger" id="noRecordsLabel">Error</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="closeBtn1"></button>
                </div>
                <div class="modal-body" id="noRecords1">
                    <!-- Error message content -->
                </div>
            </div>
        </div>
    </div>
    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmStatusModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Status Change</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to change the status?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                    <button type="button" class="btn btn-primary" id="confirmStatusChange">Yes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Redirecting Modal -->
    <div class="modal fade" id="redirectModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <span id="lblMessage" class="text-break">Redirecting...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Modal for Empty Table -->
    <div class="modal fade" id="errorModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Error! No Records found</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <p>Double check the student I.D number before verifying.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container d-flex justify-content-center align-items-center vh-100">
        <div class="card p-3 w-100 w-md-75 w-lg-50">
            <div class="card-body">
                <!-- Go Back Button -->
                <button id="goToDashboard" class="btn btn-secondary btn-back mb-3">
                    <span class="material-symbols-outlined">arrow_back</span> Go Back
                </button>

                <!-- Responsive Table with Sticky Header -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle text-center" id="sanctionTable">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th>Offense</th>
                                <th>Sanction</th>
                                <th>Assigned to</th>
                                <th>Assigned by</th>
                                <th>Assigned on</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.SanctionInfo == null || !Model.SanctionInfo.Any())
                            {
                                <tr>
                                    <td colspan="6" class="text-muted py-3">No records found</td>
                                </tr>
                            }
                            else
                            {
                                foreach (loginmodel item in Model.SanctionInfo)
                                {
                                    <tr>
                                        <td class="fw-bold">@Html.DisplayFor(modelItem => item.off_def)</td>
                                        <td><button class="btn btn-warning btn-sm w-100">@Html.DisplayFor(modelItem => item.sanction_def)</button></td>
                                        <td>@Html.DisplayFor(modelItem => item.fullname)</td>
                                        <td>@Html.DisplayFor(modelItem => item.name)</td>
                                        <td class="text-nowrap">@Html.DisplayFor(modelItem => item.assigned_date)</td>
                                        <td>
                                            <button class="btn btn-sm w-100 status-btn @(item.sanct_status == "Resolved" ? "btn-success disabled" : "btn-danger")"
                                                    data-id="@item.prior_no"
                                                    @(item.sanct_status == "Resolved" ? "disabled" : "")>
                                                @item.sanct_status
                                            </button>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="~/Scripts/jquery-3.7.1.js"></script>
    <script src="~/Scripts/bootstrap.bundle.js"></script>
    <script>
        $(document).ready(function () {
            // Check if there are no records (excluding the "No records found" message)
            if ($('#sanctionTable tbody tr td').hasClass('text-muted')) {
                $('#errorModal').modal('show');

                // Redirect to dashboard after 0.9 seconds
                setTimeout(function () {
                    window.location.href = '@Url.Action("AdminDashboard", "dashboard")';
                }, 1500);
            }

            // Redirect after manually closing the error modal
            $('#errorModal').on('hidden.bs.modal', function () {
                window.location.href = '@Url.Action("AdminDashboard", "dashboard")';
            });

            // Change Sanction Status
            $('.status-btn').click(function () {
                let priorNo = $(this).data('id'); // Get prior_no from the button

                // Show confirmation modal
                $('#confirmStatusModal').modal('show');

                // When 'Yes' is clicked, send AJAX request
                $('#confirmStatusChange').off('click').on('click', function () {
                    $.ajax({
                        url: '@Url.Action("Put_Sanction_Status", "Violation")',
                        type: 'PUT',
                        data: { prior_number: priorNo }, // Send only prior_no
                        dataType: 'text',
                        contentType: "application/x-www-form-urlencoded",
                        success: function (data) {
                            if (data === 'Status Changed.') {
                                $('#changedStat').modal('show');
                                $('#changedStat1').text('Status Changed.');
                                setTimeout(function () {
                                    $('#changedStat').modal('hide');
                                    location.reload(); // Reload to reflect changes
                                }, 2000);
                            } else {
                                $('#noRecords').modal('show');
                                $('#noRecords1').text(data);
                            }
                        },
                        error: function (jqXHR) {
                            $('#noRecords').modal('show');
                            $('#noRecords1').text(jqXHR.responseText);
                        }
                    });
                });
            });

            // Go back to dashboard with redirect modal
            $('#goToDashboard').click(function () {
                $('#redirectModal').modal('show');
                setTimeout(function () {
                    $('#redirectModal').modal('hide');
                    window.location.href = '@Url.Action("AdminDashboard", "dashboard")';
                }, 2000);
            });
        });
    </script>
</body>
</html>

